# 故事线商业化 - 智能剧情总结插入系统

## 📋 项目背景概述

### 核心业务逻辑
用户与角色扮演AI进行多轮对话时，系统会在适当时机生成**剧情总结**作为商业化内容，包含：
- 📖 **章节剧情总结**：小说风格的情节梳理
- 🏆 **达成成就**：用户互动中的亮点提炼  
- 💬 **精彩对白**：戏剧张力最强的对话片段
- 📊 **互动复盘**：关键行为和情绪反应统计

### 技术挑战
**问题**：总结生成需要较长时间（30秒-2分钟），期间用户可能继续对话多轮，如何避免在对话高潮时突兀插入总结？

**解决方案**：开发智能判断系统，分析对话节奏，选择合适时机插入总结。

---

## ⚙️ 系统运作流程

### 第一阶段：触发总结生成
```
用户对话达到60轮 → 系统后台开始生成总结（异步处理）
```

### 第二阶段：等待生成完成
```
总结生成中... (30秒-2分钟不等)
用户继续对话: 61轮、62轮、63轮...
```

### 第三阶段：智能插入判断
```
总结完成时刻：用户已对话到第63轮
↓
【判断AI启动】分析第63轮对话是否适合插入
↓
适合 → 立即插入总结
不适合 → 继续监听下一轮对话，重新判断
```

### 第四阶段：保底机制
```
连续10-15轮都不适合插入 → 强制插入（避免无限等待）
```

---

## 🎯 判断标准体系

### ✅ **适合插入的情况**
**核心条件**（满足任意1项 + 无反例）：
1. **剧情小目标达成** - 一个小的剧情任务完成
2. **对话形成闭环** - 话题有了初步的解决或结论
3. **场景/时间切换** - 明确提及换场景或时间跳跃

**典型示例**：
- 冲突化解，角色关系有了新的定位
- 从室内走到室外，场景自然切换
- 一段争吵告一段落，双方各自冷静

### ❌ **不适合插入的情况**  
**反例条件**（存在任意1项即不适合）：
1. **未解决冲突** - 争吵正激烈，矛盾尚未化解
2. **新行动待执行** - 角色刚提出新的行动计划
3. **疑问未答** - 重要问题刚抛出，等待回应  
4. **冲突升级** - 紧张气氛正在上升

**典型示例**：
- 角色刚掏出匕首，打斗一触即发
- 用户刚问出关键问题，等待角色回答
- 新人物刚出场，剧情即将发生重大转折

---

## 📝 手工标注示例分析

基于`中断示例.js`中的标注点：

| 轮次位置 | 对话内容 | 适合原因 | 判断类型 |
|---------|---------|---------|---------|
| 62轮后 | 陆远威胁性发言，话题有初步结论 | 对话形成闭环 | ✅ 适合 |
| 74轮后 | 陆远情绪缓解，矛盾暂时平息 | 剧情小目标达成 | ✅ 适合 |  
| 149轮后 | 陆沉带女主离开，场景切换 | 场景/时间切换 | ✅ 适合 |
| 176轮后 | 陆沉受伤，一个冲突小结 | 剧情小目标达成 | ✅ 适合 |
| 187轮后 | 兄弟情感表露，情绪波动平息 | 对话形成闭环 | ✅ 适合 |
| 198轮后 | 女主推开陆沉，态度明确 | 剧情小目标达成 | ✅ 适合 |
| 266轮后 | 到达家门口，明确场景切换 | 场景/时间切换 | ✅ 适合 |
| 277轮后 | 林浩离开，当前情节告一段落 | 剧情小目标达成 | ✅ 适合 |

---

## 🔧 技术实现要点

### 数据输入格式
```javascript
// 当前轮次对话（需要判断的这一轮）
{
  "role": "user", 
  "content": "用户输入内容"
}
{
  "role": "assistant",
  "content": "AI角色回应内容"  
}

// 历史上下文（前5-10轮对话作为背景）
[...previous_dialogues]
```

### 判断AI输出格式
```json
{
  "is_chapter_end": boolean,
  "chapter_ending_narration": "适合时填写衔接旁白，不适合时填null",
  "judgment_basis": "基于对话内容说明判断理由"
}
```

### 衔接旁白要求
- **字数控制**：50-150字
- **风格统一**：网文小说风格，第三人称叙事
- **自然衔接**：不突兀，承接当前对话内容
- **称呼规范**：用"你"指代用户，避免"用户"、"角色"等称呼
- **不引入新元素**：基于现有剧情，可预留引子但不添加新情节

---

## 📊 业务价值与用户体验

### 商业价值
- **内容增值**：将用户对话转化为精美的章节总结
- **用户留存**：成就系统增强用户满足感和粘性
- **数据价值**：互动行为统计为产品优化提供数据支持

### 用户体验优化
- **智能时机**：避免在剧情高潮时打断，保持沉浸感
- **内容质量**：提供有价值的剧情梳理和成就反馈
- **个性化**：基于真实对话生成，每个用户的总结都是独特的

---

## 🚀 下一步工作

1. **优化判断提示词**：基于需求分析完善AI判断逻辑
2. **测试验证**：用更多对话样本验证判断准确性  
3. **保底机制设计**：确定强制插入的轮次限制和策略
4. **性能优化**：确保判断过程不影响用户对话体验

---

*文档创建时间：2025-08-29*  
*基于互动数据1.js和中断示例.js的分析结果*