# 挑战系统重构需求文档

## 一、项目背景

### 1.1 什么是挑战系统？
挑战系统是一个**AI角色互动游戏功能**，用户可以与AI扮演的角色进行对话，完成特定目标的挑战。

**举例说明**：
- 用户选择"霸道总裁"角色 → 挑战目标：3分钟内让他说"我爱你"
- 用户选择"鲁迅"角色 → 挑战目标：说服他承认"网络文学也是文学"
- 用户选择"严格老师"角色 → 挑战目标：让他同意延期交作业

### 1.2 现有系统架构
```
用户输入
    ↓
第一阶段：意图识别（判断要玩哪类游戏）
    ↓
第二阶段：路由分发（分配到5个模板之一）
    ↓
执行固定模板workflow
    ↓
返回游戏结果
```

### 1.3 当前的5个模板

| 模板名称 | 游戏规则 | 典型场景 |
|---------|---------|---------|
| **10回合判断** | 10轮对话后判断角色是好人还是坏人 | 识破伪装的真面目 |
| **3分钟提升好感** | 3分钟内把好感度从0提到100 | 挽回前任 |
| **20回合情感博弈** | 看谁先说"我爱你" | 情侣吵架和好 |
| **限时人设切换** | 让角色答应特定要求，成功后解锁隐藏性格 | 让傲娇变成乖巧 |
| **限时目标达成** | 在时限内让角色说出指定话语 | 让老板同意涨薪 |

## 二、核心问题

### 2.1 系统僵化问题

**问题描述**：每个模板的参数都是写死的，无法灵活调整。

**实际案例**：
- ❌ 用户想要"15回合判断"→ 系统只支持10回合
- ❌ 用户想要"5分钟攻略"→ 系统只有3分钟选项
- ❌ 用户想要"让角色承认错误"→ 系统没有这个模板

### 2.2 场景局限问题

**问题描述**：现有模板过度聚焦在恋爱情感场景。

**用户需求 vs 系统能力**：
| 用户想要 | 系统提供 | 问题 |
|---------|---------|------|
| 说服鲁迅接受新观点 | 提升好感度到100 | 鲁迅不是恋爱对象 |
| 和爱因斯坦辩论物理 | 让对方说"我爱你" | 科学家不适合谈情说爱 |
| 商业谈判说服客户 | 判断好人坏人 | 商业场景不是判断善恶 |

### 2.3 用户输入问题

**问题描述**：真实用户不会给出清晰指令。

**实际用户输入案例**：
- "玩" → 系统不知道用户想玩什么
- "😈" → 系统无法解析表情含义
- "虐一下" → 系统不理解这种口语化表达
- "让他破防" → 系统没有对应的模板

### 2.4 维护成本问题

**现状**：
- 6个独立提示词（1个意图识别 + 5个模板）
- 5个独立workflow
- 5个独立接口
- 任何改动需要修改多处

## 三、解决方案

### 3.1 核心理念：从固定模板到智能生成

```
旧模式：用户输入 → 选择模板 → 执行固定流程
新模式：用户输入 → 智能理解 → 动态生成配置 → 灵活执行
```

### 3.2 技术架构

#### 3.2.1 智能理解层（新的统一提示词）

**功能**：理解用户意图，分析角色特征，生成挑战配置

**输入输出示例**：
```json
// 输入
{
  "user_input": "玩",
  "character": "霸道总裁",
  "character_desc": "冷酷商业精英，掌控欲强"
}

// 智能分析后输出
{
  "场景类型": "情感挑战",
  "限制条件": {"type": "time", "value": 180},
  "挑战目标": {"type": "说出话语", "content": "我需要你"},
  "角色立场": {
    "初始态度": "冷漠疏离",
    "抗拒原因": "不愿示弱",
    "突破口": "展现独立能力"
  },
  "开场白": "（冷冷地看着你）三分钟，说完就走。"
}
```

#### 3.2.2 通用执行层（统一的Workflow模板）

**核心设计**：用配置驱动行为，而不是写死流程

```
通用Workflow结构：

1. 读取配置JSON
2. 根据配置初始化：
   - IF 限制类型 = "time" → 启动倒计时
   - IF 限制类型 = "round" → 启动轮次计数
   
3. 进入交互循环：
   - 显示开场白
   - 接收用户输入
   - AI生成回应
   - 检查成功条件：
     - IF 目标类型 = "说出话语" → 语义检测
     - IF 目标类型 = "改变立场" → 数值检测
     - IF 目标类型 = "做出判断" → 显示选择按钮
   
4. 结算：
   - IF 成功 → 显示成功结局/解锁内容
   - IF 失败 → 显示失败信息
```

### 3.3 配置参数体系

**通用配置结构（每个字段的含义）**：
```javascript
{
  // ===== 基础文本内容（所有挑战都需要）=====
  
  "角色名称": "鲁迅",  
  // 说明：AI要扮演的角色名字
  
  "角色立场": "传统文学至上，认为网络小说都是垃圾",  
  // 说明：角色的初始态度和坚持的观点，决定了AI的对抗强度
  
  "开场白": "（放下手中的笔，冷冷地看着你）又来和我讨论那些网络小说？",
  // 说明：游戏开始时角色说的第一句话，营造氛围
  
  "挑战标题": "说服文学大师",
  // 说明：显示给用户的游戏标题，5-15个字
  
  "背景介绍": "鲁迅认为网络文学都是快餐文化，你要说服他承认网络文学的价值",
  // 说明：告诉用户为什么要做这个挑战，60-80字的故事背景
  
  // ===== 游戏规则设置 =====
  
  "限制条件": {
    "type": "time",     // 限制类型：time(计时) | round(计轮次) | mixed(都有)
    "value": 180        // 具体数值：如果是time则为秒数，如果是round则为轮数
  },
  // 完整例子：
  // time模式: {"type": "time", "value": 180} = 3分钟内完成
  // round模式: {"type": "round", "value": 10} = 10轮对话内完成
  
  "挑战目标": {
    "type": "说出话语",           // 目标类型（4选1）：
                                  // - "说出话语": 让角色说特定的话
                                  // - "改变立场": 改变角色的数值（如好感度）
                                  // - "做出行为": 让角色同意做某件事
                                  // - "做出判断": 让用户判断角色的真实意图
    
    "content": "网络文学也是真正的文学",   // 目标内容：
                                          // - 如果type是"说出话语"：这里填角色要说的话
                                          // - 如果type是"做出行为"：这里填角色要做的事
                                          // - 如果type是"做出判断"：这里填判断选项
    
    "threshold": 100              // 目标数值（仅在type为"改变立场"时使用）：
                                 // - 好感度要达到100
                                 // - 信任度要达到80等
  },
  
  // ===== 成功后的奖励 =====
  
  "奖励机制": {
    "type": "故事结局",           // 奖励类型（3选1）：
                                 // - "解锁人设": 成功后角色性格大变
                                 // - "故事结局": 成功后显示特殊剧情
                                 // - "数值达成": 成功后显示达成的数值
    
    "content": "鲁迅微笑着说：看来我该重新审视这个时代的文学了"  
    // 奖励内容：根据type不同
    // - 如果是"解锁人设"：这里写新人设描述
    // - 如果是"故事结局"：这里写结局文本
    // - 如果是"数值达成"：这里写成就描述
  },
  
  // ===== 难度控制 =====
  
  "难度设定": {
    "level": "困难",              // 难度等级：简单|中等|困难
                                  // - 简单：角色容易被说服
                                  // - 中等：需要一定技巧
                                  // - 困难：角色极度顽固
    
    "defense_strategy": "逻辑反驳、引经据典、情感冷漠"  
    // 角色的防御策略：描述角色会如何抵抗用户
    // - 例如："转移话题、假装没听见、生气"
    // - 例如："用专业术语压制、质疑你的资格"
  }
}
```

**实际配置示例（让你更好理解）**：

```javascript
// 示例1：恋爱挑战
{
  "角色名称": "傲娇总裁",
  "角色立场": "绝不承认喜欢你，维持高冷形象",
  "开场白": "（冷漠地看了你一眼）三分钟，有事快说",
  "挑战标题": "融化冰山总裁",
  "背景介绍": "傲娇总裁明明很在意你，却总是口是心非，让他承认真心",
  
  "限制条件": {"type": "time", "value": 180},  // 3分钟
  "挑战目标": {
    "type": "说出话语",
    "content": "我喜欢你",
    "threshold": null  // 这个字段不需要，因为不是数值类目标
  },
  "奖励机制": {
    "type": "解锁人设",
    "content": "撒娇奶狗：会主动撒娇求抱抱"
  },
  "难度设定": {
    "level": "中等",
    "defense_strategy": "口是心非、转移话题、假装生气"
  }
}

// 示例2：非恋爱挑战
{
  "角色名称": "严格数学老师",
  "角色立场": "作业必须按时交，没有例外",
  "开场白": "（推了推眼镜）作业呢？今天是截止日期",
  "挑战标题": "说服老师延期",
  "背景介绍": "你的作业还没写完，需要说服以严格著称的数学老师延期",
  
  "限制条件": {"type": "round", "value": 10},  // 10轮对话
  "挑战目标": {
    "type": "做出行为",
    "content": "同意延期交作业",
    "threshold": null
  },
  "奖励机制": {
    "type": "故事结局",
    "content": "老师叹了口气：就这一次，下不为例"
  },
  "难度设定": {
    "level": "困难",
    "defense_strategy": "讲原则、举反例、威胁扣分"
  }
}
```

## 四、实施方案

### 4.1 第一阶段：构建智能生成器
- 开发新的统一提示词
- 能够处理模糊输入
- 输出标准化配置

### 4.2 第二阶段：改造Workflow
- 将5个固定模板合并为1个
- 改为配置驱动的动态流程
- 保留所有现有功能

### 4.3 第三阶段：接口适配
- 新建统一接口
- 旧接口作为wrapper调用新接口
- 确保向后兼容

### 4.4 第四阶段：逐步迁移
- A/B测试新旧系统
- 收集用户反馈
- 逐步切换流量

## 五、预期收益

### 5.1 用户体验提升
| 改进项 | 之前 | 之后 |
|-------|------|------|
| **灵活性** | 只能10轮/3分钟等固定值 | 任意轮次/时间 |
| **场景丰富度** | 仅限情感恋爱 | 学术/商业/日常等全场景 |
| **输入友好度** | 需要明确指令 | 模糊输入也能理解 |
| **个性化** | 5种固定玩法 | 无限种可能 |

### 5.2 技术收益
- **维护成本**：6个提示词 → 2个
- **扩展性**：新玩法无需新模板
- **代码复用**：1个通用workflow替代5个
- **迭代效率**：修改一处，全局生效

## 六、风险与对策

| 风险点 | 影响 | 对策 |
|-------|------|------|
| AI理解偏差 | 生成错误配置 | 增加校验和兜底逻辑 |
| 性能问题 | 响应变慢 | 优化提示词，减少推理步骤 |
| 兼容性问题 | 旧功能受影响 | 充分测试，灰度发布 |

## 七、成功标准

1. **功能完整性**：新系统能覆盖原5个模板的所有功能
2. **用户满意度**：支持更多玩法，用户活跃度提升20%
3. **维护效率**：新增玩法时间从1周降到1天
4. **系统稳定性**：错误率不高于原系统

## 八、时间规划

| 阶段 | 工作内容 | 预计时间 |
|------|---------|---------|
| 第一周 | 智能提示词开发与测试 | 5天 |
| 第二周 | Workflow改造 | 5天 |
| 第三周 | 接口开发与联调 | 5天 |
| 第四周 | 测试与优化 | 5天 |
| 第五周 | 灰度发布与监控 | 持续 |

## 九、相关文档

- [现有5个挑战模板详细分析](./修改需求.md)
- [Agent架构说明](./agent架构流程/)
- [意图识别提示词](./temp/意图识别/挑战玩法意图识别提示词.md)

## 十、FAQ

**Q: 为什么不直接加更多模板？**
A: 模板越多，维护成本越高，且永远无法覆盖所有用户需求。

**Q: 会影响现有用户吗？**
A: 不会，我们保留旧接口，逐步迁移。

**Q: AI生成会不会不稳定？**
A: 我们会设置默认值和校验机制，确保稳定性。

**Q: 这个改造的核心价值是什么？**
A: 让系统从"固定玩法"变成"智能玩法生成器"，一次改造，永久受益。

---

*文档版本：v1.0*
*创建日期：2024-12*
*负责人：挑战玩法项目组*