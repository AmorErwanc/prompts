## 判断好坏结局
加入回合数输出变量

## 20回合提升好感度
输出回合数变量

## 三分钟提升好感度
输出时间变量

## 挑战玩法架构重构需求

### 现状问题
1. **意图识别过于复杂**：采用两阶段意图识别（第一阶段：判断游戏类型；第二阶段：路由到5个具体模板），维护成本高
2. **模板输出死板**：5个挑战提示词输出内容固定（如固定10回合），无法满足用户个性化需求
3. **路由局限性**：用户多元化需求难以简单映射到现有5个固定模板
4. **维护困难**：需要维护多个意图识别提示词和5个独立的挑战提示词
5. **用户输入问题**：真实用户输入往往极度模糊（如"玩一下"、"虐"、发表情等），现有系统无法智能处理

### 五个挑战提示词共性分析

#### 共同输出变量（所有模板100%包含）
- **内在人设**：第二人称描述角色心理状态和防御机制
- **角色开场白**：（动作/表情）+对话内容，营造挑战氛围
- **挑战标题**：5-15字吸引用户的标题
- **内容描述**：30-40字的游戏规则说明
- **背景介绍**：60-80字的关系背景和挑战起因

#### 抽象化的变量分类及对应关系

##### 1. 限制条件
**定义**：挑战的时间或回合限制，决定用户有多少机会达成目标
- **judge_10r**：10回合对话限制
- **love_3m**：3分钟（180秒）时间限制
- **love_20r**：20回合对话限制
- **switch_persona**：可配置时间限制（180-600秒）
- **timed_goal**：可配置时间限制（180-600秒）

##### 2. 核心目标
**定义**：用户在挑战中需要达成的主要任务类型
- **判断类**：识别角色真实意图（judge_10r - 判断好人坏人）
- **情感类**：提升好感度或获得情感认可（love_3m - 好感度到100；love_20r - 让对方说"我爱你"）
- **行为类**：让角色做特定动作或说特定话语（switch_persona - 答应穿女仆装；timed_goal - 承认某事）

##### 3. 成功条件
**定义**：判定挑战是否成功的具体标准
- **二选一判断**：judge_10r（选对角色真实意图）
- **数值达标**：love_3m（好感度=100）
- **行为触发**：love_20r（对方说"我爱你"）、switch_persona（说出指定话语）、timed_goal（达成指定目标）

##### 4. 角色心理
**定义**：角色的内在人设和动机的统一，包含性格特征、防御机制、过去经历、情感障碍
- **judge_10r**：通过"内在人设"定义双面性格，表里不一的心理状态
- **love_3m**：通过"内在人设"+"角色动机"说明为何好感度低，冷漠的原因
- **love_20r**：通过"内在人设"+"角色动机"描述争吵背景和情绪变化
- **switch_persona**：通过"内在人设"描述抗拒心理和防御姿态
- **timed_goal**：通过"内在人设"说明不愿接受的深层原因

##### 5. 奖励机制
**定义**：挑战成功后用户获得的奖励或解锁的内容
- **特殊结局**：judge_10r（成功/失败的不同故事结局）
- **情感突破**：love_3m（挽回成功）、love_20r（和好如初）
- **隐藏人设**：switch_persona（解锁完全不同的角色性格）
- **目标达成**：timed_goal（达成目标本身就是奖励）

##### 6. 交互机制
**定义**：用户与角色互动的主要方式
- **对话+选择**：judge_10r（10轮对话后二选一）
- **纯对话**：love_3m、love_20r、switch_persona、timed_goal

##### 7. 难度设定
**定义**：挑战的难易程度及角色的防御强度
- **judge_10r**：通过角色伪装程度控制（越会演戏越难）
- **love_3m**：通过初始好感度低和时间压力控制
- **love_20r**：通过角色争吵激烈程度控制
- **switch_persona**：明确的"挑战难度"变量，描述防御策略（话术转移、情感冻结）
- **timed_goal**：明确的"挑战难度"变量，描述心理防线强度

#### 差异化变量（特定模板独有，仅占20%）
- **judge_10r独有**：选项描述、结局设置（二选一机制）
- **love_3m/love_20r共有**：角色动机（但与内在人设重复，可合并）
- **switch_persona独有**：隐藏人设（奖励机制的一种）
- **timed_goal/switch_persona共有**：挑战时间、挑战难度（可参数化）

### 核心诉求
1. **统一融合**：将5个挑战提示词（judge_10r、love_3m、love_20r、switch_persona、timed_goal）合并为一个通用的、更灵活的提示词
2. **简化流程**：取消第二阶段意图识别，只保留第一阶段
3. **提升灵活性**：让系统能够接受和处理更多元的用户需求（如用户想要15回合而非固定10回合）
4. **保持兼容**：需要考虑接口层面的适配问题（现有架构是一个提示词对应一个接口）

### 解决方案

#### 智能挑战生成器设计理念
1. **主动设计而非被动解析**：系统基于角色特点主动设计挑战，而不是等待用户给出明确指令
2. **角色驱动**：以角色性格、关系设定为核心设计依据
3. **智能兜底**：用户输入模糊甚至空白时，系统能自动生成合适的挑战
4. **参数自动补全**：所有缺失的参数都能根据角色和情境智能推断

#### 统一提示词架构
创建一个智能挑战生成器，能够：
- 接收任意用户输入（包括空白、表情、错别字等）
- 分析角色特点（性格类型、关系设定）
- 主动设计适合的挑战类型
- 动态生成所需的输出变量组合
- 自动填充所有必要参数

#### 接口层方案
1. **新增统一工具**：创建smart_challenge_generator工具
2. **保持向后兼容**：旧的5个工具作为wrapper调用新工具
3. **渐进式迁移**：先A/B测试，逐步切换流量

### 实施步骤
1. **第一阶段**：设计并实现通用智能挑战提示词
2. **第二阶段**：简化意图识别，移除第二阶段路由
3. **第三阶段**：部署新工具，保留旧工具兼容
4. **第四阶段**：根据效果逐步迁移到新架构

### 预期效果
- 用户体验提升：任何输入都能得到合适的挑战
- 维护成本降低：从6个提示词减少到2个
- 灵活性增强：支持自定义回合数、时间等参数
- 扩展性提高：新增挑战类型无需改动框架

### 待解决问题
- 如何设计通用的挑战提示词，既能保持灵活性，又能满足不同挑战类型的需求
- 如何调整接口层架构，支持单一提示词多种输出模式
- 如何确保向后兼容，不影响现有功能