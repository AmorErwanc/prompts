# 挑战系统配置生成流程图

## 核心流程逻辑

```mermaid
graph TB
    Start([用户点击生成配置]) --> CheckFixed{检查固定框架}
    
    %% 固定框架验证分支
    CheckFixed -->|缺失必填项| ShowError[显示缺失字段提示]
    ShowError --> End1([结束])
    
    CheckFixed -->|全部填写| InitConfig[初始化配置对象]
    
    %% 配置初始化
    InitConfig --> AddFixed[添加固定框架数据]
    AddFixed --> |角色名称<br/>角色立场<br/>开场白<br/>挑战标题<br/>背景介绍| CheckSlots{检查可选插槽}
    
    %% 插槽处理主流程
    CheckSlots --> ProcessLimit{处理限制条件插槽}
    ProcessLimit -->|有模块| CheckLimitType{检查限制类型}
    ProcessLimit -->|空| ProcessGoal{处理挑战目标插槽}
    
    %% 限制条件分支
    CheckLimitType -->|时间限制| AddTimeLimit[添加时间数值]
    CheckLimitType -->|轮次限制| AddRoundLimit[添加轮次数值]
    AddTimeLimit --> ProcessGoal
    AddRoundLimit --> ProcessGoal
    
    %% 挑战目标分支
    ProcessGoal -->|有模块| CheckGoalType{检查目标类型}
    ProcessGoal -->|空| ProcessReward{处理奖励机制插槽}
    
    CheckGoalType -->|说出话语| AddSpeechGoal[添加话语内容]
    CheckGoalType -->|做出行为| AddActionGoal[添加行为内容]
    CheckGoalType -->|改变立场| AddValueGoal[添加数值目标]
    CheckGoalType -->|做出判断| AddJudgeGoal[添加判断选项]
    
    AddSpeechGoal --> ProcessReward
    AddActionGoal --> ProcessReward
    AddValueGoal --> ProcessReward
    AddJudgeGoal --> ProcessReward
    
    %% 奖励机制分支
    ProcessReward -->|有模块| CheckRewardType{检查奖励类型}
    ProcessReward -->|空| ProcessDifficulty{处理回避策略插槽}
    
    CheckRewardType -->|解锁人设| AddCharReward[添加人设描述]
    CheckRewardType -->|故事结局| AddStoryReward[添加结局描述]
    CheckRewardType -->|数值达成| AddScoreReward[添加成就描述]
    
    AddCharReward --> ProcessDifficulty
    AddStoryReward --> ProcessDifficulty
    AddScoreReward --> ProcessDifficulty
    
    %% 回避策略分支
    ProcessDifficulty -->|有模块| AddStrategy[添加策略描述]
    ProcessDifficulty -->|空| GenerateJSON[生成JSON配置]
    AddStrategy --> GenerateJSON
    
    %% 输出结果
    GenerateJSON --> DisplayConfig[显示配置结果]
    DisplayConfig --> CheckEmpty{是否有可选插槽}
    CheckEmpty -->|无| AddHint[添加提示信息]
    CheckEmpty -->|有| End2([完成])
    AddHint --> End2

    %% 样式定义
    classDef required fill:#fef3c7,stroke:#f59e0b,stroke-width:2px
    classDef optional fill:#dbeafe,stroke:#3b82f6,stroke-width:2px
    classDef process fill:#e9d5ff,stroke:#9333ea,stroke-width:2px
    classDef decision fill:#fce7f3,stroke:#ec4899,stroke-width:2px
    classDef output fill:#d1fae5,stroke:#10b981,stroke-width:2px
    
    class CheckFixed,InitConfig,AddFixed required
    class ProcessLimit,ProcessGoal,ProcessReward,ProcessDifficulty optional
    class CheckLimitType,CheckGoalType,CheckRewardType,CheckEmpty decision
    class GenerateJSON,DisplayConfig output
```

## 数据验证逻辑

```mermaid
graph LR
    subgraph 固定框架验证
        V1[角色名称] -->|非空| Valid1{✓}
        V2[角色立场] -->|非空| Valid2{✓}
        V3[开场白] -->|非空| Valid3{✓}
        V4[挑战标题] -->|非空| Valid4{✓}
        V5[背景介绍] -->|非空| Valid5{✓}
    end
    
    subgraph 可选插槽验证
        S1[限制条件] -->|检查数值| OptValid1{?}
        S2[挑战目标] -->|检查内容| OptValid2{?}
        S3[奖励机制] -->|检查描述| OptValid3{?}
        S4[回避策略] -->|检查策略| OptValid4{?}
    end
    
    Valid1 & Valid2 & Valid3 & Valid4 & Valid5 --> AllRequired[必填项完整]
    OptValid1 & OptValid2 & OptValid3 & OptValid4 --> OptionalComplete[可选项处理]
    
    AllRequired --> FinalConfig[最终配置]
    OptionalComplete --> FinalConfig
```

## 插槽数据结构

```mermaid
graph TD
    subgraph 限制条件数据结构
        Limit[限制条件] --> TimeStruct["type: 'time'<br/>value: 180"]
        Limit --> RoundStruct["type: 'round'<br/>value: 10"]
    end
    
    subgraph 挑战目标数据结构
        Goal[挑战目标] --> SpeechStruct["type: '说出话语'<br/>content: '我爱你'"]
        Goal --> ActionStruct["type: '做出行为'<br/>content: '握手'"]
        Goal --> ValueStruct["type: '改变立场'<br/>threshold: 100"]
        Goal --> JudgeStruct["type: '做出判断'<br/>content: '好人|坏人'"]
    end
    
    subgraph 奖励机制数据结构
        Reward[奖励机制] --> CharStruct["type: '解锁人设'<br/>content: '描述文本'"]
        Reward --> StoryStruct["type: '故事结局'<br/>content: '描述文本'"]
        Reward --> ScoreStruct["type: '数值达成'<br/>content: '描述文本'"]
    end
    
    subgraph 回避策略数据结构
        Difficulty[回避策略] --> StrategyStruct["strategy: '策略描述文本'"]
    end
```

## 用户交互流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant UI as 界面
    participant V as 验证器
    participant G as 生成器
    participant D as 显示器
    
    U->>UI: 拖入模块到插槽
    UI->>UI: 更新插槽显示
    U->>UI: 填写输入框
    UI->>UI: 保存输入值
    U->>UI: 点击生成配置
    UI->>V: 验证固定框架
    
    alt 验证失败
        V-->>UI: 返回缺失字段
        UI-->>U: 显示错误提示
    else 验证成功
        V->>G: 传递有效数据
        G->>G: 组装配置对象
        G->>G: 处理可选插槽
        G->>D: 传递JSON配置
        D->>UI: 格式化显示
        UI-->>U: 展示最终配置
    end
```

## 配置生成状态机

```mermaid
stateDiagram-v2
    [*] --> 空白状态
    空白状态 --> 部分填写: 用户输入
    部分填写 --> 部分填写: 继续输入
    部分填写 --> 拖入模块: 拖放操作
    拖入模块 --> 配置就绪: 必填项完整
    配置就绪 --> 生成中: 点击生成
    生成中 --> 验证中: 检查数据
    
    验证中 --> 生成失败: 缺少必填项
    验证中 --> 生成成功: 验证通过
    
    生成失败 --> 部分填写: 返回修改
    生成成功 --> 显示结果: 输出JSON
    显示结果 --> [*]: 完成
    
    显示结果 --> 空白状态: 清空重置
```

## 核心函数调用关系

```mermaid
graph TD
    generateConfig[generateConfig主函数] --> collectFixed[收集固定框架数据]
    generateConfig --> validateRequired[验证必填项]
    generateConfig --> processSlots[处理可选插槽]
    generateConfig --> outputJSON[输出JSON]
    
    processSlots --> processLimit[处理限制条件]
    processSlots --> processGoal[处理挑战目标]
    processSlots --> processReward[处理奖励机制]
    processSlots --> processDifficulty[处理回避策略]
    
    processLimit --> updateLimitValue[更新数值]
    processGoal --> updateGoalContent[更新内容]
    processReward --> updateRewardContent[更新描述]
    processDifficulty --> updateDifficultyStrategy[更新策略]
    
    outputJSON --> formatJSON[格式化JSON]
    outputJSON --> displayResult[显示结果]
    outputJSON --> addHints[添加提示]
    
    %% 辅助函数
    clearAll[clearAll清空函数] --> resetInputs[重置输入框]
    clearAll --> clearSlots[清空插槽]
    clearAll --> resetDisplay[重置显示]
    
    loadPreset[loadPreset预设函数] --> fillFixed[填充固定数据]
    loadPreset --> insertModules[插入模块]
    loadPreset --> autoGenerate[自动生成]
```

## 数据流向图

```mermaid
graph LR
    subgraph 输入层
        I1[用户输入]
        I2[拖放模块]
        I3[预设选择]
    end
    
    subgraph 处理层
        P1[数据收集]
        P2[数据验证]
        P3[数据转换]
    end
    
    subgraph 输出层
        O1[JSON配置]
        O2[UI反馈]
        O3[错误提示]
    end
    
    I1 --> P1
    I2 --> P1
    I3 --> P1
    
    P1 --> P2
    P2 -->|成功| P3
    P2 -->|失败| O3
    
    P3 --> O1
    P3 --> O2
    
    style I1 fill:#fef3c7
    style I2 fill:#fef3c7
    style I3 fill:#fef3c7
    style P1 fill:#dbeafe
    style P2 fill:#dbeafe
    style P3 fill:#dbeafe
    style O1 fill:#d1fae5
    style O2 fill:#d1fae5
    style O3 fill:#fee2e2
```

---

这些流程图完整展示了配置生成功能的：
1. **主流程** - 从用户操作到最终输出的完整路径
2. **验证逻辑** - 必填项和可选项的验证机制
3. **数据结构** - 各个插槽的数据组织方式
4. **交互时序** - 用户与系统的交互顺序
5. **状态转换** - 系统在不同状态间的转换
6. **函数关系** - 核心函数的调用层次
7. **数据流向** - 数据在系统中的流动路径